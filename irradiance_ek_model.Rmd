---
title: "Mixed-Effects Model for Irradiance Time Above Ek"
author: "Angela Richards Don√†"
date: "6/23/2022"
output: html_document
---

#script for mixed model analysis of Ek and irradiance

Load the various libraries
```{r, warning=FALSE}
library(lme4)
library(lmerTest)
library(effects)
library(car)
library(MuMIn)
library (dplyr)
library(emmeans)
library(DHARMa)
library(performance)
library(patchwork)
library(rstatix)
#for plots and tables
library(ggplot2)
library(ggpubr)
library(forcats)
library(RColorBrewer)
library(tidyverse)
library(sjPlot)
library(sjmisc)
library(mmtable2)
library(gt)
library(purrr)
library(stringr)
library(tidyr)
```

Load the data

```{r}
ek_irrad_data <- read.csv("/Users/Angela/src/work/limu/irradiance_ek/output/irrad_ek.csv")
```

Assign run as a factor
```{r}
ek_irrad_data$Run <- as.factor(ek_irrad_data$Run)
```

Assign temperature as a factor
```{r}
ek_irrad_data$Temperature <- as.factor(ek_irrad_data$Temp...C.)
```

Assigns treatment as characters from integers then to factors
```{r}
ek_irrad_data$Treatment <- as.factor(as.character(ek_irrad_data$Treatment))
```

Assign deltaNPQ as a factor
```{r}
ek_irrad_data$deltaNPQ <- as.factor(ek_irrad_data$deltaNPQ)
```

Toggle between the species for output. Use Day 9 for final analysis
recent change: removing the very odd ek.1 value of 559.4 in hypnea dataset
```{r}
hypnea <- subset(ek_irrad_data, Species == "hm" & RLC.Day == 9 & ek.1 < 226)
hypnea$treatment_graph[hypnea$Treatment == 1] <- "1) 35ppt/14umol" 
hypnea$treatment_graph[hypnea$Treatment == 2] <- "2) 28ppt/27umol" 
hypnea$treatment_graph[hypnea$Treatment == 3] <- "4) 18ppt/53umol" 
hypnea$treatment_graph[hypnea$Treatment == 4] <- "5) 11ppt/80umol"
hypnea$treatment_graph[hypnea$Treatment == 5] <- "3) 28ppt/53umol"

ulva <- subset(ek_irrad_data, Species == "ul" & RLC.Day == 9)
ulva$treatment_graph[ulva$Treatment == 0] <- "1) 35ppt/0.5umol"
ulva$treatment_graph[ulva$Treatment == 1] <- "2) 35ppt/14umol" 
ulva$treatment_graph[ulva$Treatment == 2] <- "3) 28ppt/27umol" 
ulva$treatment_graph[ulva$Treatment == 3] <- "4) 18ppt/53umol" 
ulva$treatment_graph[ulva$Treatment == 4] <- "5) 11ppt/80umol"
```

Add growth rate from other dataset to this one and subset by species
```{r}
growth_rate <- read.csv("/Users/Angela/src/work/limu/algal_growth_photosynthesis/data_input/run5-6_growth_all_042922.csv")
growth_rate$Species <- as.factor(growth_rate$Species)
growth_rate$treatment <- as.factor(growth_rate$treatment)
```

Subset the growth rate data by Species
```{r}
gr_ulva <- subset(growth_rate, Species == "Ul")
gr_hypnea <- subset(growth_rate, Species == "Hm" & final.weight != 0.1017 & final.weight != 0.3224)
```

Calculate the growth rate from the data
```{r}
ulva$growth_rate <- round((gr_ulva$final.weight - gr_ulva$Initial.weight) / gr_ulva$Initial.weight * 100, digits = 2)
hypnea$growth_rate <- round((gr_hypnea$final.weight - gr_hypnea$Initial.weight) / gr_hypnea$Initial.weight * 100, digits = 2)
```

#_______________________ULVA____________________________
 
Run model without interaction between the treatments and temperature - irradiance_over_ek is in minutes. Take RLC.Order out of the random effects because it is causing problems of singularity. R2 is same with or without (+ (1 | RLC.Order))

```{r}
ek_irrad_model_noint_ulva <- lmer(formula = irradiance_over_ek ~ Treatment + Temperature + (1 | Run) + (1 | Plant.ID), data = ulva)
```

Get an r2 for the model
```{r}
r.squaredGLMM(ek_irrad_model_noint_ulva)
```

Make histograms of data and residuals (first test for mixed model use) and residual plots of the data for ulva
```{r}
hist(ulva$irradiance_over_ek, main = paste("Ulva lactuca"), col = "olivedrab3", labels = TRUE)
hist(resid(ek_irrad_model_noint_ulva))
plot(resid(ek_irrad_model_noint_ulva) ~ fitted(ek_irrad_model_noint_ulva))
qqnorm(resid(ek_irrad_model_noint_ulva))
qqline(resid(ek_irrad_model_noint_ulva))
```

Check the performance of the model and run a summary
```{r}
performance::check_model(ek_irrad_model_noint_ulva)
summary(ek_irrad_model_noint_ulva)
```

Check for equal variance to determine which ANOVA to use
```{r}
bartlett.test(irradiance_over_ek ~ Treatment, data = ulva)
```

Run Welch's ANOVA if not equal variance. Code forces one independent variable at a time. Games Howell Test for pairwise comparison for the only independent variable that was found to have significant results. 
```{r}
welch_anova_treatment_ulva <- oneway.test(irradiance_over_ek ~ Treatment, data = ulva, var.equal = FALSE)
welch_anova_treatment_ulva
welch_anova_temp_ulva <- oneway.test(irradiance_over_ek ~ Temperature, data = ulva, var.equal = FALSE)
welch_anova_temp_ulva
games_howell_test(ulva, irradiance_over_ek ~ Treatment, conf.level = 0.95, detailed = TRUE)
```

## Run ANOVA and pairwise comparisons IF variance is equal (not the case here)
anova(ek_irrad_model_noint_ulva, type = c("III"), ddf = "Satterthwaite")
ulva_ek_irrad_model_aov <- aov(irradiance_over_ek ~ Treatment + Temperature, data = ulva)
TukeyHSD(ulva_ek_irrad_model_aov, "Treatment", ordered = FALSE)
TukeyHSD(ulva_ek_irrad_model_aov, "Temperature", ordered = FALSE)

```{r}
plot(allEffects(ek_irrad_model_noint_ulva))
```

Plot a regression between the photosynthetic independent variables of interest and growth rate
```{r}
ulva_growth_irrad_ek_graph <- ggplot(ulva, aes(x=irradiance_over_ek, y=growth_rate)) + geom_point() + 
        geom_smooth(method = "lm", col = "black") + theme_bw() + 
        labs(title = "Ulva lactuca Minutes above Ek vs Growth Rate", x = "Minutes above Ek", 
             y = "growth rate (%)") + stat_regline_equation(label.x = 25, label.y = 165) + stat_cor()
ulva_growth_irrad_ek_graph
```

Plot a histogram in ggplot2
```{r}
ulva %>% ggplot(aes(irradiance_over_ek)) +
        geom_histogram(binwidth=5, fill = "#5BB300", color = "black", size = 0.25, alpha = 0.85) +
        theme_bw()
```

Make a boxplot for publications of the results
```{r}
ulva %>% ggplot(aes(treatment_graph, irradiance_over_ek)) + 
        geom_boxplot(size=0.5) + 
        geom_point(alpha = 0.5, size = 3, aes(color = Temperature), show.legend = TRUE) + 
        labs(x="Treatment (salinty/nitrate)", y= "Time above Ek (min)", title= "Time above Ek", subtitle = "Ulva lactuca") + 
        scale_x_discrete(labels = c("35ppt/0.5umolN", "35ppt/14umolN", "28ppt/27umolN", "18ppt/53umolN", "11ppt/80umolN")) + 
        stat_mean() + 
        geom_hline(yintercept=0, color = "orange", size = 0.5, alpha = 0.5) +
        scale_color_manual(values = c("#999999", "#E69F00", "#56B4E9")) +
        theme_bw()
```

#______________________HYPNEA___________________________ 

Run model for Hypnea
```{r}
ek_irrad_model_noint_hypnea <- lmer(formula = irradiance_over_ek ~ Treatment + Temperature + (1 | Run) + (1 | Plant.ID), data = hypnea)
```

Get an r2 for the model
```{r}
r.squaredGLMM(ek_irrad_model_noint_hypnea)
```

Make histograms of data and residuals (first test for mixed model use) and residual plots of the data for Hypnea
```{r}
hist(hypnea$irradiance_over_ek, main = paste("Hypnea musciformis"), col = "maroon", labels = TRUE)
hist(resid(ek_irrad_model_noint_hypnea))
plot(resid(ek_irrad_model_noint_hypnea) ~ fitted(ek_irrad_model_noint_hypnea))
qqnorm(resid(ek_irrad_model_noint_hypnea))
qqline(resid(ek_irrad_model_noint_hypnea))
```

Check the performance of the model
```{r}
performance::check_model(ek_irrad_model_noint_hypnea)
```

Run a summary of the model
```{r}
summary(ek_irrad_model_noint_hypnea)
```

Check for equal variance
```{r}
bartlett.test(irradiance_over_ek ~ Treatment, data = hypnea)
```

Run Welch's ANOVA if not equal variance. Code forces one independent variable at a time. Games Howell Test for pairwise comparison for the only independent variable that was found to have significant results.
```{r}
welch_anova_treatment <- oneway.test(irradiance_over_ek ~ Treatment, data = hypnea, var.equal = FALSE)
welch_anova_treatment
welch_anova_temp <- oneway.test(irradiance_over_ek ~ Temperature, data = hypnea, var.equal = FALSE)
welch_anova_temp
games_howell_test(hypnea, irradiance_over_ek ~ Treatment, conf.level = 0.95, detailed = TRUE)
games_howell_test(hypnea, irradiance_over_ek ~ Temperature, conf.level = 0.95, detailed = TRUE)
```

If ANOVA more appropriate (not this case) run from code above with Tukey's HSD pairwise comparisons where appropriate

Plot results for basic output
```{r}
plot(allEffects(ek_irrad_model_noint_hypnea))
```

Plot a regression between the photosynthetic independent variables of interest and growth rate and a histogram of the data
```{r}
hypnea_growth_irrad_ek_graph <- ggplot(hypnea, aes(x=irradiance_over_ek, y=growth_rate)) + geom_point() + 
        geom_smooth(method = "lm", col = "black") + theme_bw() + 
        labs(title = "Hypnea musciformis Minutes above Ek vs Growth Rate", x = "Minutes above Ek", y = "growth rate (%)") + 
        stat_regline_equation(label.y = 155) + stat_cor(label.y = 145)
hypnea_growth_irrad_ek_graph

hypnea %>% ggplot(aes(irradiance_over_ek)) +
        geom_histogram(binwidth=5, fill = "#a8325e", color = "black", size = 0.25, alpha = 0.85) +
        theme_bw()
```

Make a boxplot for publications of the results
```{r}
hypnea %>% ggplot(aes(treatment_graph, irradiance_over_ek)) + 
        geom_boxplot(size=0.5) + 
        geom_point(alpha = 0.5, size = 3, aes(color = Temperature), show.legend = TRUE) + 
        labs(x="Treatment (salinty/nitrate)", y= "Time above Ek (min)", title= "Time above Ek", subtitle = "Hypnea musciformis") + 
        scale_x_discrete(labels = c("35ppt/14umolN", "28ppt/27umolN", "28ppt/53umolN", "18ppt/53umolN", "11ppt/80umolN")) + 
        stat_mean() + 
        geom_hline(yintercept=0, color = "orange", size = 0.5, alpha = 0.5) +
        scale_color_manual(values = c("#999999", "#E69F00", "#56B4E9")) +
        theme_bw()
```
